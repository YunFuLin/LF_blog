---
title: ä½¿ç”¨pnpm çš„ monorepoæ¶æ„å¤šåŒ…ç®¡ç†
date: 2024-12-20 21:24:17
layout: 'archives'
urlname: notes
keywords: 'ä½¿ç”¨pnpm çš„ monorepoæ¶æ„å¤šåŒ…ç®¡ç†'
tags: 
- pnpm
categories: 
- ç¬”è®°
---

**å¯ä»¥ä½¿ç”¨ **`pnpm`** çš„ monorepo æ¶æ„æ¥å…±äº«å…¬å…±ç»„ä»¶ã€æ–¹æ³•å’Œç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œä¸”æ•ˆæœéå¸¸å¥½ï¼**  
ç›¸æ¯”ä¼ ç»Ÿçš„ `npm` å’Œ `yarn`ï¼Œ`pnpm` åœ¨ monorepo åœºæ™¯ä¸‹æä¾›äº†**æ›´å¥½çš„åŒ…ç®¡ç†æ€§èƒ½å’Œä¾èµ–å»é‡**ï¼Œç‰¹åˆ«é€‚åˆå¾®å‰ç«¯æ¶æ„ã€‚



## ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°
`pnpm` monorepo ä¸»è¦ä¾èµ– `workspace` æœºåˆ¶ï¼ŒæŠŠå¤šä¸ªå­åº”ç”¨å’Œå…¬å…±åŒ…ç»Ÿä¸€ç®¡ç†åœ¨ä¸€ä¸ª**å•ä¸€çš„ä»“åº“**ä¸­ã€‚  
ä¸»åº”ç”¨å’Œå­åº”ç”¨å¯ä»¥ç›´æ¥**å…±äº«å…¬å…±ç»„ä»¶åº“ã€å·¥å…·æ–¹æ³•ã€ç¬¬ä¸‰æ–¹åŒ…**ï¼Œé¿å…é‡å¤å®‰è£…å’Œç‰ˆæœ¬å†²çªã€‚

## äºŒã€å¦‚ä½•å®ç°ï¼Ÿ
### ğŸ”¹ 1. åˆ›å»º `pnpm` monorepo é¡¹ç›®
```bash

mkdir microfrontend-monorepo && cd microfrontend-monorepo
pnpm init
```

**åœ¨ `package.json` é‡Œå¯ç”¨ `workspaces`ï¼š**

```json

{
  "name": "microfrontend-monorepo",
  "private": true,
  "workspaces": ["packages/*", "apps/*"]
}
```

+ `packages/` ğŸ‘‰ å­˜æ”¾å…±äº«çš„å…¬å…±ç»„ä»¶åº“ã€å·¥å…·åº“
+ `apps/` ğŸ‘‰ å­˜æ”¾ä¸»åº”ç”¨å’Œå­åº”ç”¨

### ğŸ”¹ 2. æ·»åŠ å…±äº«çš„ `packages`
```bash

mkdir -p packages/shared-ui packages/shared-utils
```

#### ğŸ“Œ åˆ›å»º `shared-ui`ï¼ˆå…±äº«ç»„ä»¶åº“ï¼‰
```bash
cd packages/shared-ui
pnpm init
```

**å®‰è£… React ç»„ä»¶ä¾èµ–ï¼ˆå¦‚æœæ˜¯ Vue åˆ™ç”¨ `vue`ï¼‰**

```bash
pnpm add react react-dom
```

**åˆ›å»º `index.tsx`**

```tsx
// packages/shared-ui/src/Button.tsx
import React from "react";

export const Button = ({ text }: { text: string }) => {
  return <button style={{ padding: "10px 20px", background: "blue", color: "white" }}>{text}</button>;
};
```
**å¯¼å‡ºç»„ä»¶**

```tsx
// packages/shared-ui/index.ts
export * from "./src/Button";
```

**æ·»åŠ  `package.json` é…ç½®**

```json

{
  "name": "@micro/shared-ui",
  "version": "1.0.0",
  "main": "index.ts",
  "peerDependencies": {
    "react": "^18.0.0",
    "react-dom": "^18.0.0"
  }
}
```

#### ğŸ“Œ åˆ›å»º `shared-utils`ï¼ˆå…±äº«å·¥å…·åº“ï¼‰
```bash

cd ../shared-utils
pnpm init
```

**æ·»åŠ å·¥å…·å‡½æ•°**

```tsx
// packages/shared-utils/index.ts
export const formatDate = (date: string) => new Date(date).toLocaleString();
```

**é…ç½® `package.json`**

```json
{
  "name": "@micro/shared-utils",
  "version": "1.0.0",
  "main": "index.ts"
}
```

### ğŸ”¹ 3. åˆ›å»º `apps` ç›®å½•ï¼ˆä¸»åº”ç”¨å’Œå­åº”ç”¨ï¼‰
```plain
mkdir -p apps/main-app apps/sub-app
```

#### ğŸ“Œ é…ç½®ä¸»åº”ç”¨
```bash
cd apps/main-app
pnpm init
pnpm add react react-dom @micro/shared-ui @micro/shared-utils
```

**åœ¨ `App.tsx` é‡Œä½¿ç”¨å…±äº«ç»„ä»¶å’Œæ–¹æ³•**

```tsx
import React from "react";
import { Button } from "@micro/shared-ui";
import { formatDate } from "@micro/shared-utils";

const App = () => {
  return (
    <div>
      <h1>ä¸»åº”ç”¨</h1>
      <Button text="ç‚¹å‡»æˆ‘" />
      <p>å½“å‰æ—¶é—´ï¼š{formatDate(Date.now().toString())}</p>
    </div>
  );
};

export default App;
```

#### ğŸ“Œ é…ç½®å­åº”ç”¨
```bash
cd ../sub-app
pnpm init
pnpm add react react-dom @micro/shared-ui @micro/shared-utils
```

**å­åº”ç”¨ `App.tsx`**

```tsx
import React from "react";
import { Button } from "@micro/shared-ui";

const SubApp = () => {
  return (
    <div>
      <h2>å­åº”ç”¨</h2>
      <Button text="æˆ‘æ˜¯å­åº”ç”¨çš„æŒ‰é’®" />
    </div>
  );
};

export default SubApp;
```

### ğŸ”¹ 4. åœ¨ `pnpm` monorepo é‡Œå®‰è£…ä¾èµ–
å›åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼Œè¿è¡Œï¼š

```bash
pnpm install
```

`pnpm` ä¼šè‡ªåŠ¨**å»é‡ä¾èµ–**ï¼Œæ‰€æœ‰ `packages` å’Œ `apps` å…±äº«ç›¸åŒçš„ `node_modules`ï¼Œæå‡æ„å»ºé€Ÿåº¦ã€‚

---

## ä¸‰ã€å¯åŠ¨ä¸»åº”ç”¨å’Œå­åº”ç”¨
### æ–¹å¼ 1ï¼šç‹¬ç«‹è¿è¡Œï¼ˆé€‚åˆéå¾®å‰ç«¯æ¨¡å¼ï¼‰

```bash
cd apps/main-app && pnpm start
cd apps/sub-app && pnpm start
```

è¿™æ ·ä¸»åº”ç”¨å’Œå­åº”ç”¨å¯ä»¥å„è‡ªç‹¬ç«‹è¿è¡Œã€‚

### æ–¹å¼ 2ï¼šå¾®å‰ç«¯æ•´åˆï¼ˆé€‚åˆ qiankunã€Module Federationï¼‰
#### ä½¿ç”¨ `qiankun` å¾®å‰ç«¯æ¡†æ¶
**ä¸»åº”ç”¨ï¼ˆ`main-app`ï¼‰**

```tsx
import { registerMicroApps, start } from "qiankun";

registerMicroApps([
  {
    name: "sub-app",
    entry: "//localhost:3001",
    container: "#subapp-container",
    activeRule: "/subapp",
  },
]);

start();
```

**å­åº”ç”¨ï¼ˆ`sub-app`ï¼‰**

```tsx
import { render } from "react-dom";
import SubApp from "./App";

export async function bootstrap() {
  console.log("å­åº”ç”¨ bootstrap");
}

export async function mount(props) {
  console.log("å­åº”ç”¨ mount", props);
  render(<SubApp />, document.getElementById("root"));
}

export async function unmount() {
  console.log("å­åº”ç”¨ unmount");
}
```

---

## å››ã€ä¼˜åŠ¿åˆ†æ
âœ… **å…±äº«ç»„ä»¶åº“ & å·¥å…·åº“**ï¼šæ‰€æœ‰å­åº”ç”¨å…±ç”¨ `@micro/shared-ui` å’Œ `@micro/shared-utils`ï¼Œä»£ç å¤ç”¨ç‡é«˜ã€‚  
âœ… **è‡ªåŠ¨ä¾èµ–å»é‡**ï¼š`pnpm` é‡‡ç”¨**ç¡¬é“¾æ¥**ï¼Œä¸ä¼šé‡å¤å®‰è£… Reactã€Ant Design ç­‰ç¬¬ä¸‰æ–¹åŒ…ã€‚  
âœ… **ç‹¬ç«‹å¼€å‘ & ç»Ÿä¸€ç®¡ç†**ï¼šå­åº”ç”¨å¯ä»¥**ç‹¬ç«‹å¼€å‘**ï¼Œä½†ä¹Ÿèƒ½äº«å— monorepo çš„**ä¾èµ–ç®¡ç†**ã€‚  
âœ… **å¾®å‰ç«¯å…¼å®¹æ€§å¼º**ï¼šå¯ä»¥é…åˆ **qiankun**ã€**Module Federation** **Web Components** ç­‰æ–¹å¼å®ç°å¾®å‰ç«¯ã€‚

---

## äº”ã€é€‚åˆçš„åœºæ™¯
+ **å¤šå­åº”ç”¨å…±äº«ç»„ä»¶åº“ã€å·¥å…·åº“**
+ **æ¯ä¸ªå­åº”ç”¨å¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œä½†ä¹Ÿèƒ½åˆå¹¶æˆå¾®å‰ç«¯**
+ **å‡å°‘é‡å¤å®‰è£… Reactã€Vueã€Ant Design ç­‰ä¾èµ–**
+ **é€‚ç”¨äº Viteã€Webpackã€Rollup ç­‰ç°ä»£æ„å»ºå·¥å…·**

---

## å…­ã€æ€»ç»“
å¦‚æœä½ çš„å¾®å‰ç«¯æ¶æ„æ¶‰åŠå¤šä¸ª React/Vue å­åº”ç”¨ï¼Œä¸”å¸Œæœ›å…±äº«å…¬å…±ç»„ä»¶ã€å·¥å…·æ–¹æ³•ã€ç¬¬ä¸‰æ–¹åŒ…ï¼Œ**pnpm monorepo æ˜¯æœ€ä½³é€‰æ‹©ï¼**

ğŸ”¹ **å°è§„æ¨¡å›¢é˜Ÿ**ï¼šç›´æ¥ç”¨ `pnpm workspaces` ç®¡ç†ä¾èµ–å’Œå…±äº«ç»„ä»¶ã€‚  
ğŸ”¹ **å¤§è§„æ¨¡å›¢é˜Ÿ**ï¼šç»“åˆ `qiankun` æˆ– `Module Federation`ï¼Œå®ç°åŠ¨æ€åŠ è½½ã€æŒ‰éœ€å…±äº«ç»„ä»¶ã€‚

å¦‚æœä½ ä»¬çš„é¡¹ç›®éœ€æ±‚æ›´å¤æ‚ï¼Œæ¯”å¦‚è¦**åŠ¨æ€åŠ è½½ä¸åŒç‰ˆæœ¬çš„ç»„ä»¶åº“**ï¼Œä¹Ÿå¯ä»¥è¿›ä¸€æ­¥ç»“åˆ **Webpack Module Federation** è¿›è¡Œä¼˜åŒ–ã€‚  
ä½ ç›®å‰æ˜¯æƒ³ç”¨å“ªç§å¾®å‰ç«¯æ¡†æ¶ï¼ˆqiankunã€Web Componentsã€Module Federationï¼‰ï¼Ÿæˆ‘å¯ä»¥ç»™ä½ æ›´å…·ä½“çš„å®ç°æ–¹æ¡ˆï¼
